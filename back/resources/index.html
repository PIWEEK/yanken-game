<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Yanken - WebSockets Test Playground</title>
    <style>
     * { font-family: monospace; }
     .buttons {
       display:flex;
       flex-direction: column;
     }

     .row {
       padding: 5px;
       border: 1px solid gray;
     }

     .buttons button {
       /* max-width: 300px; */
       margin-bottom: 2px;
       cursor: pointer;
     }
    </style>
  </head>
  <body>
    <header>
      <h1>Yanken - WebSockets Test Playground</h1>
    </header>
    <main>
      <section class="buttons">
        <div class="row">
          <button id="echo">CMD: echo</button>
          <button id="clear">CMD: clear</button>
        </div>
        <div class="row">
          <button id="hello">CMD: hello</button>
        </div>
        <div class="row">
          <button id="join-room">CMD: join-room</button>
          <button id="join-bots">CMD: join-bots</button>
        </div>
        <div class="row">
          <button id="start-game">CMD: start-game</button>
        </div>
        <div class="row">
          <button id="result-1">CMD: result (rock) </button>
          <button id="result-2">CMD: result (paper) </button>
          <button id="result-3">CMD: result (scissors) </button>
        </div>
      </section>
    </main>
    <script>

     let sessionId = localStorage.getItem("sessionId") || null;
     let currentRequestId = 0;

     function getNextRequestId() {
         return currentRequestId++;
     }

     const ws = new WebSocket("ws://" + location.host);

     function send (msg) {
         if (msg.type === "request") {
             msg.requestId = getNextRequestId();
         }

         const data = JSON.stringify(msg, null, 2);
         console.log("ws(send):", data);
         ws.send(data);
     };

     ws.addEventListener("open", (event) => {
         console.log("ws(connected)");
     });

     ws.addEventListener("error", (event) => {
         console.log("ws(error):", event);
     })

     ws.addEventListener("close", (event) => {
         console.log("ws(close)", event);
     });

     ws.addEventListener("message", (event) => {
         const data = JSON.parse(event.data);
         console.log("ws(received):", JSON.stringify(data, null, 2));

         if (data.type === "response"
             && data.name === "hello") {
             localStorage.setItem("sessionId",data.session.id)
             sessionId = data.session.id;
         }

     });

     const echoBtn = document.getElementById("echo");
     echoBtn.addEventListener("click", (event) => {
         console.log("btn(click): echo");
         send({
             "type": "request",
             "name": "echo",
             "n" : Date.now()
         });
     });

     const clearBtn = document.getElementById("clear");
     clearBtn.addEventListener("click", (event) => {
         console.log("btn(click): clear");
         localStorage.clear();
     });

     const joinRoomBtn = document.getElementById("join-room");
     joinRoomBtn.addEventListener("click", (event) => {
         console.log("btn(click): join-room");
         send({
             "type": "request",
             "name": "joinRoom",
             "roomId": "test-room-id"
             /* "withBots": 20, */
             /* "botJoinTimeout": 2000 */
         });
     });

     const joinBotsBtn = document.getElementById("join-bots");
     joinBotsBtn.addEventListener("click", (event) => {
         console.log("btn(click): join-bots");
         send({
             "type": "notification",
             "name": "joinBots",
             "roomId": "test-room-id",
             "botNum": 3,
             "botJoinTimeout": 2000
         });
     });


     const startGame = document.getElementById("start-game");
     startGame.addEventListener("click", (event) => {
         console.log("btn(click): start-game");
         send({
             "type": "request",
             "name": "startGame",
             "options": {
             }
         });
     });


     const helloBtn = document.getElementById("hello");
     helloBtn.addEventListener("click", (event) => {
         console.log("btn(click): hello");
         send({
             "type": "request",
             "name": "hello",
             "sessionId": sessionId,
             "playerAvatar": "avatar-1",
             "playerName": "Pepito"
         });
     });

     const resultBtn1 = document.getElementById("result-1");
     const resultBtn2 = document.getElementById("result-2");
     const resultBtn3 = document.getElementById("result-3");

     function onResultClicked(n) {
         return function(event) {
             console.log("btn(click): result-" + n);
             send({
                 "type": "request",
                 "name": "sendTurn",
                 "result": n
             });
         };
     }

     resultBtn1.addEventListener("click", onResultClicked(1));
     resultBtn2.addEventListener("click", onResultClicked(2));
     resultBtn3.addEventListener("click", onResultClicked(3));

    </script>
  </body>
</html>
